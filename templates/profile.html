{% extends "base.html" %}
{% block title %}Profile - Ramathon{% endblock %}

{% block content %}
{% set level = get_level(user.get('dist_year', 0)) %}
{% set next_level, xp_needed = get_next_level(user.get('dist_year', 0)) %}

<div style="max-width: 600px; margin: 40px auto; padding: 0 20px;">
    
    <div class="card" style="text-align: center; position: relative;">
        <div style="position: absolute; top: 10px; right: 10px; transform: rotate(5deg);">
            <div class="lvl-badge" style="background: {{ level.color }};">
                {{ level.icon }} {{ level.name }}
            </div>
        </div>

        <img src="{{ user.profile }}" style="width:120px; height:120px; border-radius:50%; border:4px solid {{ level.color }}; margin-bottom:15px; padding: 2px;">
        
        <h1 style="font-family:'Limelight', 'Noto Sans Thai'; margin:0; text-transform: uppercase; font-size: 2rem;">
            {{ user.firstname }} {{ user.lastname }}
        </h1>
        
        <div style="margin-top: 10px; font-weight: bold; font-family: 'Noto Sans Thai'; color: var(--ink);">
            {% if user.team %}
                <span style="background: var(--paper); border: 1px solid var(--ink); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">{{ user.team }}</span>
            {% endif %}
            {% if user.year %}
                <span style="background: var(--ink); color: white; padding: 2px 8px; border-radius: 4px; margin-left: 5px; font-size: 0.8rem;">{{ user.year }}</span>
            {% endif %}
        </div>
        
        {% if user.status or user.motto %}
        <p style="font-style: italic; color: #666; margin: 15px 0 5px 0;">"{{ user.status if user.status else user.motto }}"</p>
        {% endif %}
    </div>

    <div class="card" style="margin-top: 20px;">
        <h3 style="font-family: 'Limelight'; margin-top: 0; border-bottom: 2px dashed #eee; padding-bottom: 10px;">
            RUNNER STATS (2026)
        </h3>

        <div style="margin-bottom: 20px;">
            <div class="progress-label">
                <span>{{ text.stats_month }}</span>
                <span>{{ user.get('dist_month', 0) }} / 50 KM</span>
            </div>
            <div class="progress-track">
                <div class="progress-bar bar-purple" style="width: {{ (user.get('dist_month', 0) / 50 * 100)|round|int }}%; max-width: 100%;"></div>
            </div>
        </div>

        <div style="margin-bottom: 20px; position: relative;">
            {% if shirt_active %}
                <div class="progress-label" style="color: {% if user.get('dist_quarter', 0) >= 100 %}var(--gold){% else %}inherit{% endif %};">
                    <span>{{ text.stats_quarter }}</span>
                    <span>{{ user.get('dist_quarter', 0) }} / 100 KM</span>
                </div>
                <div class="progress-track" style="border-color: var(--gold);">
                    <div style="position: absolute; right: 5px; top: 0; font-size: 0.8rem; line-height: 18px;">ðŸ‘•</div>
                    <div class="progress-bar bar-gold" style="width: {{ (user.get('dist_quarter', 0) / 100 * 100)|round|int }}%; max-width: 100%;"></div>
                </div>
                {% if user.get('dist_quarter', 0) >= 100 %}
                    <div style="text-align: center; font-weight: bold; font-size: 0.8rem; background: #FFF9C4; padding: 5px; border-radius: 4px; color: #F57F17;">
                        {% if user.get('has_received_shirt') %}
                            {{ text.badge_shirt_wait }} - {{ text.msg_shirt_next }}
                        {% else %}
                            ðŸŽ‰ {{ text.badge_shirt_qual }} - {{ text.msg_shirt_win }}
                        {% endif %}
                    </div>
                {% endif %}
            {% else %}
                <div class="progress-label" style="opacity: 0.5;">
                    <span>{{ text.stats_quarter }}</span>
                    <span>ðŸ”’ {{ text.locked_q2 }}</span>
                </div>
                <div class="progress-track" style="border-color: #ccc; background: #ddd; position: relative;">
                     <div style="position: absolute; width: 100%; text-align: center; top: 0; font-size: 0.7rem; color: #666; line-height: 18px; font-weight: bold; letter-spacing: 1px;">COMING Q2 2026</div>
                </div>
            {% endif %}
        </div>

        <div style="border-top: 2px dashed #eee; padding-top: 15px;">
            <div class="progress-label" style="color: var(--blue); font-size: 0.9rem;">
                <span>{{ text.stats_total }} ({{ level.name }})</span>
                {% if next_level %}
                    <span>{{ xp_needed }} {{ text.xp_to_next }} {{ next_level.name }} {{ next_level.icon }}</span>
                {% else %}
                    <span>{{ text.xp_max }}</span>
                {% endif %}
            </div>
            <div class="progress-track" style="border-color: var(--blue); height: 25px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);">
                <div class="progress-bar bar-blue" style="width: {{ (user.get('dist_year', 0) / level.max * 100)|round|int }}%; max-width: 100%;"></div>
            </div>
        </div>
    </div>

    {% if not readonly %}
    <div style="text-align: center; margin-top: 15px;">
        <a href="{{ url_for('update_stats') }}" class="btn-purple" style="font-size: 0.8rem;">{{ text.btn_sync }}</a>
    </div>

    <div class="card" style="margin-top: 20px; background: #fffcf0;">
        <h3 style="font-family: 'Limelight', 'Noto Sans Thai'; color: var(--purple); text-align: center; margin-top: 0;">EDIT PROFILE</h3>
        <form action="{{ url_for('update_profile') }}" method="POST">
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">{{ text.lbl_team }}</label>
                <select name="team" id="teamSelect" onchange="updateYearOptions()" style="width: 100%; padding: 10px; border: 2px solid var(--ink); font-family: 'Noto Sans Thai'; background: white;">
                    <option value="" disabled {% if not user.team %}selected{% endif %}>-- Select Team --</option>
                    <option value="MD" {% if user.team == 'MD' %}selected{% endif %}>{{ text.opt_md }}</option>
                    <option value="NR" {% if user.team == 'NR' %}selected{% endif %}>{{ text.opt_nr }}</option>
                    <option value="ER" {% if user.team == 'ER' %}selected{% endif %}>{{ text.opt_er }}</option>
                    <option value="CD" {% if user.team == 'CD' %}selected{% endif %}>{{ text.opt_cd }}</option>
                    <option value="Staff" {% if user.team == 'Staff' %}selected{% endif %}>{{ text.opt_staff }}</option>
                    <option value="Other" {% if user.team == 'Other' %}selected{% endif %}>{{ text.opt_other }}</option>
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">{{ text.lbl_year }}</label>
                <select id="yearMD" name="year" style="width: 100%; padding: 10px; border: 2px solid var(--ink); font-family: 'Noto Sans Thai'; background: white; display: none;">
                    {% for i in range(1, 7) %}<option value="{{ i }}" {% if user.year == i|string %}selected{% endif %}>Year {{ i }}</option>{% endfor %}
                    <option value="Grad" {% if user.year == 'Grad' %}selected{% endif %}>{{ text.opt_grad }}</option>
                </select>
                <select id="yearStd" name="year" style="width: 100%; padding: 10px; border: 2px solid var(--ink); font-family: 'Noto Sans Thai'; background: white; display: none;">
                    {% for i in range(1, 5) %}<option value="{{ i }}" {% if user.year == i|string %}selected{% endif %}>Year {{ i }}</option>{% endfor %}
                    <option value="Grad" {% if user.year == 'Grad' %}selected{% endif %}>{{ text.opt_grad }}</option>
                </select>
                <input type="text" id="yearText" name="year" value="{{ user.year }}" placeholder="e.g. Lecturer" style="width: 93%; padding: 10px; border: 2px solid var(--ink); font-family: 'Noto Sans Thai'; display: none;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">{{ text.lbl_status }}</label>
                <input type="text" name="status" maxlength="40" value="{{ user.status }}" style="width: 93%; padding: 10px; border: 2px solid var(--ink);">
            </div>
            <div style="display: flex; gap: 15px;">
                <div style="flex: 1;">
                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">{{ text.lbl_motto }}</label>
                    <input type="text" name="motto" maxlength="20" value="{{ user.motto }}" style="width: 85%; padding: 10px; border: 2px solid var(--ink);">
                </div>
                <div style="flex: 1;">
                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">{{ text.lbl_shoe }}</label>
                    <input type="text" name="shoe" maxlength="20" value="{{ user.shoe }}" style="width: 85%; padding: 10px; border: 2px solid var(--ink);">
                </div>
            </div>
            <button type="submit" class="btn-purple" style="width: 100%; margin-top: 20px;">{{ text.btn_save }}</button>
        </form>
    </div>
    <script>
        function updateYearOptions() {
            const team = document.getElementById('teamSelect').value;
            const yearMD = document.getElementById('yearMD');
            const yearStd = document.getElementById('yearStd');
            const yearText = document.getElementById('yearText');
            [yearMD, yearStd, yearText].forEach(el => { el.style.display = 'none'; el.disabled = true; });
            if (team === 'MD') { yearMD.style.display = 'block'; yearMD.disabled = false; }
            else if (['NR', 'ER', 'CD'].includes(team)) { yearStd.style.display = 'block'; yearStd.disabled = false; }
            else { yearText.style.display = 'block'; yearText.disabled = false; }
        }
        window.onload = updateYearOptions;
    </script>
    {% endif %}
</div>
{% endblock %}